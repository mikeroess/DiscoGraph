<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DiscoGraph</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="/javascripts/bundle.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link rel="stylesheet" href="/stylesheets/style.css">

    <script>


    const genreQuery = (data) => {
      return $.ajax({
        method: "GET",
        url: 'api',
        data: data
      })
    };

    const subGenreQuery = (data) => {
      localStorage.removeItem("subgenre");
      return $.ajax({
        method: "GET",
        url: "api/subGenreQuery",
        data: data
      });
    };

    const genreColors = {
      "rock": "#8ce196",
      "pop": "steelblue",
      "hip-hop": "purple",
      "funk-soul": "orange",
      "electronic": "green",
      "classical": "brown",
      "jazz": "red",
      "subgenre": "black"
};

const genreButtonClick = function (genre, clicked, startYear, endYear) {
  writeGraph(localStorage, startYear, endYear);
  for (let i = startYear; i <= endYear; i++) {
    let data = {'genre': genre, 'year': i};
    genreQuery(data).then((response) => {
      debugger
      const oldData = JSON.parse(localStorage[genre]);
      const itemsPerYear = JSON.parse(response["text"])["pagination"]["items"];
      const year = parseInt(JSON.parse(response["text"])["results"][0]["year"])
      oldData[year] = itemsPerYear
      localStorage.setItem(genre, JSON.stringify(oldData))
      console.log(localStorage)
      writeGraph(localStorage, startYear, endYear);
    },
    (err) => {console.log(err)}

    )
  }
};

const startYearUpdate = (year) => {
  $('#startYearDisplay').val(year);
  if (year >= $('#endYearDisplay').val()) {
    $('#endYear').val(parseInt(year) + 1);
    $('#endYearDisplay').val(parseInt(year) + 1);
  }
  writeGraph(localStorage, $('#startYearDisplay').val(), $('#endYearDisplay').val() )
};

const endYearUpdate = (year) => {
  $('#endYearDisplay').val(year);
  if (year <= $('#startYearDisplay').val()) {
    $('#startYear').val(parseInt(year) - 1);
    $('#startYearDisplay').val(parseInt(year) - 1);
  }
  writeGraph(localStorage, $('#startYearDisplay').val(), $('#endYearDisplay').val() )
};

const clearChart = () => {
  $(".graph").remove();
};

const isButtonClicked = (genre) => {
  if( genre === "subgenre") return false
  const buttonId = genre + "-toggle";
  return document.getElementById(buttonId).checked;
};

const margin = {top: 30, right: 20, bottom: 30, left: 50};
const w = 1050 - margin.left - margin.right;
const h = 500 - margin.top - margin.bottom;

const xScale = d3.scaleTime()
              .rangeRound([0, w - margin.left - margin.right]);

const yScale = d3.scaleLinear()
              .rangeRound([h - margin.bottom - margin.top, 0]);

const line = d3.line()
      .x(function(d) { return xScale(d[0]) })
      .y(function(d) { return yScale(d[1]) });

const parseDate = d3.timeParse("%Y");

const formatData = (genre, startYear, endYear) => {
  const keys = Object.keys(genre).sort();
  let filteredData = keys.filter((key) => {
    if (key >= startYear && key <= endYear) {
      return true
    } else {
      return false
    }
  })
  let formattedData = filteredData.map( (key) => {
    return [parseDate(key), genre[key]] }
  );
  return formattedData;
};

const GenerateLeftAxis = (scale) => {
  const leftAxis = d3.axisLeft(scale);
  return leftAxis;
};

const GenerateBottomAxis = (scale) => {
const bottomAxis = d3.axisBottom(scale)
return bottomAxis;
};

const getMaxRelease = (genres, storage) => {
  const topReleasesPerGenre = [];
  genres.forEach( (genre) => {
    if (genre === "subgenre") return
  topReleasesPerGenre.push(d3.max(Object.values(storage[genre])));
  })
  return d3.max(topReleasesPerGenre);
}

//
// const filterObjectByYear= (object, startYear, endYear) => {
//   filteredData = {}
//   for (var year in object) {
//     if (year > startYear && year < endYear) {
//       filteredData[year] = object
//     }
//   }
// }
 const setupLocalStorage = () => {
   localStorage.removeItem("subgenre");
   genres = Object.keys(genreColors);
   genres.forEach( (genre) => {
     if (typeof(localStorage[genre]) === "undefined")
     localStorage.setItem(genre, JSON.stringify({}));
   })
 }


const writeGraph = (localData, minYear, maxYear) => {

  const genres = Object.keys(localData).filter(
    (genre) => {
      if (isButtonClicked(genre)) return genre;
    }
  );
  let globalData = {};
  genres.forEach( (genre) => {
    if (localData[genre]) {
      globalData[genre] = JSON.parse(localData[genre]);
    }
  });


  const maxNumOfReleases = getMaxRelease(genres, globalData);

  xScale.domain([parseDate(minYear), parseDate(maxYear)]);
  yScale.domain([0, maxNumOfReleases]);

  const leftAxis = GenerateLeftAxis(yScale);
  const bottomAxis = GenerateBottomAxis(xScale);

  clearChart();

  let svg = d3.select('#d3Graph').append("svg")
        .attr("class", "graph")
        .attr("width", w + margin.left + margin.right)
        .attr("height", h + margin.top + margin.bottom);

      svg.append("g")
        .attr("class", "axis")
        .attr("transform", `translate(${margin.left}, ${margin.bottom})`)
        .call(leftAxis)
      .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "0.71em")
        .attr("fill", "#000")
        .text("Number of Releases");

      svg.append("g")
      .attr("class", "axis")
        .attr("transform", `translate(${margin.left}, ${h - margin.bottom})`)
        .call(bottomAxis);

    genres.forEach( (genre) => {
      if (genre === 'subgenre') {
        const subGenreObject = JSON.parse(localStorage[genre])
        const genreName = Object.keys(subGenreObject)[0]
        const formattedDataset = formatData(subGenreObject[genreName], minYear, maxYear)
        if (formattedDataset.length === 0) { return }

        svg.append("path")
          .attr("d", line(formattedDataset))
          .attr("stroke", genreColors[genre])
          .attr("stroke-width", 2)
          .attr("fill", "none")
          .attr("transform", `translate(${margin.left}, ${margin.bottom})`)

        svg.append("text")
        .attr("transform", "translate(" + (w + 3) + "," + yScale(formattedDataset[formattedDataset.length - 1][1]) + ")")
        .attr("dy", "0.71em")
        .attr("class", "genreLabel")
        .style("fill", "black")
        .text(genreName);

      } else {
      const dataset = JSON.parse(localStorage[genre])
      const formattedDataset = formatData(dataset, minYear, maxYear)
      if (formattedDataset.length === 0) { return }

      svg.append("path")
        .attr("d", line(formattedDataset))
        .attr("stroke", genreColors[genre])
        .attr("stroke-width", 2)
        .attr("fill", "none")
        .attr("transform", `translate(${margin.left}, ${margin.bottom})`)

      svg.append("text")
        .attr("transform", "translate(" + (w + 3) + "," + yScale(formattedDataset[formattedDataset.length - 1][1]) + ")")
        .attr("dy", "0.71em")
        .attr("class", "genreLabel")
        .style("fill", genreColors[genre])
        .text(genre);
    }}
  )
}


    </script>

    <script type="text/javascript">
      $(document).ready(() => {
        const rockButton = document.getElementById("rock-toggle");
        const popButton = document.getElementById("pop-toggle");
        const hipHopButton = document.getElementById("hip-hop-toggle");
        const funkSoulButton = document.getElementById("funk-soul-toggle");
        const electronicButton = document.getElementById("electronic-toggle");
        const classicalButton = document.getElementById("classical-toggle");
        const jazzButton = document.getElementById("jazz-toggle");

        rockButton.addEventListener("click", () => genreButtonClick("rock", rockButton.clicked, $('#startYear').val(), $('#endYear').val()), false);
        popButton.addEventListener("click", () => genreButtonClick("pop", popButton.clicked, $('#startYear').val(), $('#endYear').val()), false);
        hipHopButton.addEventListener("click", () => genreButtonClick("hip-hop", hipHopButton.clicked, $('#startYear').val(), $('#endYear').val()), false);
        funkSoulButton.addEventListener("click", () => genreButtonClick("funk-soul", funkSoulButton.clicked, $('#startYear').val(), $('#endYear').val()), false);
        electronicButton.addEventListener("click", () => genreButtonClick("electronic", electronicButton.clicked, $('#startYear').val(), $('#endYear').val()), false);
        classicalButton.addEventListener("click", () => genreButtonClick("classical", classicalButton.clicked, $('#startYear').val(), $('#endYear').val()), false);
        jazzButton.addEventListener("click", () => genreButtonClick("jazz", jazzButton.clicked, $('#startYear').val(), $('#endYear').val()), false);

        setupLocalStorage()

        $("#mainForm").submit( (e) => {
          e.preventDefault();
          const data = {'sub_genre': $('#genre').val(), 'startYear': $('#startYear').val(), 'endYear': $('#endYear').val() };
          subGenreQuery(data).then((response) => {
            const genre = Object.keys(response)[0];
            const releases = response[Object.keys(response)[0]];
            const tempObject = {};
            tempObject[genre] = releases;
            localStorage.setItem("subgenre", JSON.stringify(tempObject));
            debugger
            writeGraph(localStorage, data["startYear"], data["endYear"]);
          },
        (err) => console.log(err));;
        });
      });
    </script>
  </head>


  <body>
    <header><h1 class="logo">DiscoGraphs</h1></header>
    <main>
      <form id="mainForm">
        <section class="information displayed">
          <p>Welcome to DiscoGraph, a simple interactive data-visualization built with <a href="#">d3</a> and drawing information
          from the <a href="#"> Discogs API</a><br />
          It should be fairly intuitive, but the sliders allow you to adjust the timescale of the graph.<br />
          The buttons toggle which genres are displayed.
          If the genre you're intersted in isn't present, don't fret!  Just add it as a sub-genre.  We'll gather the information from Discogs and throw it up for you.
          Please poke around and look for anything you might find interesting.<br />
          I was surprised to find that in 1978 there were more releases classified as funk or soul than pop!</p>

          <p>If you'd like to see more things I've built, check out my <a href="#">Github</a><br />
          If you're interested in hiring me, shoot me an email: <a href="mailto:michael.roess@gmail.com">Michael.Roess@gmail.com</a>.<br />
          Feel free to dig into my professional history at <a href="#">LinkedIn</a> or <a href="#">AngelList</a> if you're interested</p>
          <a href="#" class="informationWindow">Hide all this text -- let me get to the graph!</a>
        <section>


        <div class="yearInputs group">


          <label for="startYear">Start Year
            <input type="range" min="1960" max="2015" value="1970"
            name="startYear" step="1" id="startYear" oninput="startYearUpdate(value)">
            <output for="startYear" id="startYearDisplay">1970</output>
          </label>


        <label for="endYear" id="endYearLabel">End Year
          <input type="range" min="1961" max="2016" value="1985"
          name="endYear" id="endYear" oninput="endYearUpdate(value)">
          <output for="endYear" id="endYearDisplay">1985</output>
        </label>
      </div>

        <div id="d3Graph"></div>

        <section class="genre-buttons group">
          <div class="switch">
            <input type="checkbox" class="check-to-toggle" id="rock-toggle">
            <label for="rock-toggle"></label>
          </div>

          <div class="switch">
            <input type="checkbox" class="check-to-toggle" id="pop-toggle" checked>
            <label for="pop-toggle"></label>
          </div>

          <div class="switch">
            <input type="checkbox" class="check-to-toggle" id="hip-hop-toggle">
            <label for="hip-hop-toggle"></label>
          </div>

          <div class="switch">
            <input type="checkbox" class="check-to-toggle" id="funk-soul-toggle" checked>
            <label for="funk-soul-toggle"></label>
          </div>

          <div class="switch">
            <input type="checkbox" class="check-to-toggle" id="electronic-toggle">
            <label for="electronic-toggle"></label>
          </div>

          <div class="switch">
            <input type="checkbox" class="check-to-toggle" id="classical-toggle">
            <label for="classical-toggle"></label>
          </div>

          <div class="switch">
            <input type="checkbox" class="check-to-toggle" id="jazz-toggle">
            <label for="jazz-toggle"></label>
          </div>
        </section>

        <label for="genre" id="genreLabel">Sub-Genre
          <input type="text" name="genre" value="" id="genre">
          <button>Add sub-genre</button>
        </label>
      </form>
    </main>
  </body>
</html>
