<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>DiscoGraph</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script type="text/javascript" src="./bundle.js"></script>
    <link rel="stylesheet" href="./master.css"></link>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script type="text/javascript">
      $(document).ready(() => {

          const w = 750;
          const h = 400;
          const years = Object.keys(localStorage).sort();
          const maxYear = years[years.length -1];
          const minYear = years[0];
          const allNumOfReleases = years.map((year) => localStorage[year]);
          const maxNumOfReleases = d3.max(allNumOfReleases);

          const xScale = d3.scaleLinear()
                        .rangeRound([0, w - 100]);

          const yScale = d3.scaleLinear()
                        .rangeRound([h, 0]);

          const line = d3.line()
                .x((d) => parseInt(d[0]))
                .y((d) => d[1]);

            const formatData = (localStorage ) => {
              const keys = Object.keys(localStorage).sort();
              const data = keys.map( (key) => {
                return [key, localStorage[key]] }
              )
              return data;
            }

          let dataset = formatData(localStorage);

          xScale.domain(d3.extent(dataset, (d) => d[0]));
          yScale.domain(d3.extent(dataset, (d) => d[1]));

          const GenerateLeftAxis = (scale) => {
            const leftAxis = d3.axisLeft(scale);
            return leftAxis;
          };

        const GenerateBottomAxis = (scale) => {
          const bottomAxis = d3.axisBottom(scale)
                .tickFormat(d3.format("d"))
                .ticks(dataset.length);
          return bottomAxis;
        };




        const setLocalStorage = () => {
            let startYear = $('#startYear').val();
            let endYear = $('#endYear').val();
            let genre = $('#genre').val();
            for (var i = startYear; i <= endYear; i++) {
              GenreQuery(genre, i).then(
                (response) => {
                  localStorage.setItem(response['results']['0']['year'], response['pagination']['items'])
                },
                (error) => console.log(error)
              );}
        }

        $("#mainForm").submit( (e) => {
          e.preventDefault();
          // setLocalStorage();
          // const margin = {top: 20, right: 20, bottom: 30, left: 50};
          //   const width = 960 - margin.left - margin.right;
          //   const height = 500 - margin.top - margin.bottom;
          const leftAxis = GenerateLeftAxis(yScale);
          const bottomAxis = GenerateBottomAxis(xScale);
          const dataset = formatData(localStorage);

          let svgContainer = d3.select('#d3Graph').append("svg")
                .attr("width", w)
                .attr("height", h);
          //
          // let bars = svgContainer.selectAll("rect")
          //       .data(dataset)
          //       .enter()
          //       .append("rect");
          //
          // bars.attr("x", function(d, i) {
          //   return  i * (w / dataset.length) + 70;
          // })
          //     .attr("y", (d) => d[1] / h )
          //     .attr("class", "bar")
          //     .style("height", function(d) {
          //       return yScale(d[1])+ "px";
          //     });

              svgContainer.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(50)")
                .call(leftAxis);

              svgContainer.append("g")
              .attr("class", "axis")
                .attr("transform", `translate(20, ${h - 25})`)
                .call(bottomAxis);

              svgContainer.append("g")
                .data(dataset)
                .attr("class", "line")
                .attr("d", line);




          // svgContainer.data(formatData(localStorage))
          // .enter()
          // .append("div")
          // .attr("class", "bar")
          // .style("height", function(d) {
          //   console.log(d[1])
          //   return d[1] / 400 + "px";
          // })
          // .text("something?");
      });
      });
    </script>
  </head>


  <body>
    <header><h1 class="logo">DiscoGraphs</h1></header>
    <main>
      <form id="mainForm">
        <label for="year">Start Year
          <input type="text" name="startYear" value="" id="startYear">
        </label>

        <label for="year">End Year
          <input type="text" name="endYear" value="" id="endYear">
        </label>





        <label for="genre">Genre
          <input type="text" name="genre" value="" id="genre">
        </label>
        <button>submit!</button>
      </form>
              <div id="d3Graph"></div>
    </main>


  </body>
</html>
